<!DOCTYPE html>
<html class="no-js" lang="en">


<!-- Mirrored from doc.akka.io/docs/akka-http/current/client-side/connection-level.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 01 Aug 2019 10:12:55 GMT -->
<head>
<title>Connection-Level Client-Side API &bull; Akka HTTP</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="Akka Http: Modern, fast, asynchronous, streaming-first HTTP server and client."/>
<link rel="canonical" href="connection-level.html"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/foundation/dist/js/foundation.min.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/css/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../../../../cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
<link rel="stylesheet" type="text/css" href="../css/icons.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>
<link rel="shortcut icon" href="../images/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png"/>
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png"/>
<link rel="manifest" href="../images/manifest.json"/>
<meta name="msapplication-TileImage" content="../images/mstile-150x150.png"/>
<meta name="msapplication-TileColor" content="#15a9ce"/>
<meta name="theme-color" content="#15a9ce"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) start -->
<script src="../../../../../optanon.blob.core.windows.net/consent/159bb13d-6748-4399-806e-ac28db879785.js" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice (Production Standard, akka.io, en-GB) end -->
<!--Google Analytics-->
<script type="text/plain" class="optanon-category-2">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-21117439-1']);
_gaq.push(['_setDomainName', 'akka.io']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})()
</script>
<script type="text/plain" class="optanon-category-2">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','../../../../../www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-23127719-1', 'lightbend.com', {'allowLinker': true, 'name': 'tsTracker'});
ga('tsTracker.require', 'linker');
ga('tsTracker.linker:autoLink', ['lightbend.com','playframework.com','scala-lang.org','scaladays.org','spray.io','akka.io','scala-sbt.org','scala-ide.org']);
ga('tsTracker.send', 'pageview');
</script>
<!--Marketo-->
<script type="text/plain" class="optanon-category-3">
(function() {
var didInit = false;
function initMunchkin() {
if(didInit === false) {
didInit = true;
Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
}
}
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = '../../../../../munchkin.marketo.net/munchkin.js';
s.onreadystatechange = function() {
if (this.readyState == 'complete' || this.readyState == 'loaded') {
initMunchkin();
}
};
s.onload = initMunchkin;
document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
</head>

<body id="underlay" data-toggler="nav-open">

<header class="site-header hide-for-large">
<div class="sticky-header clearfix">
<a href="https://akka.io/"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

<button class="menu-icon float-right" type="button" data-toggle="underlay overlay"></button>
</div>
<div id="overlay" class="overlay-nav" data-toggler="nav-open">
<header class="nav-header">
<div class="nav-header-title">
<h1><a href="../index-2.html">Akka HTTP</a></h1>
</div>
<div class="nav-header-version">
Version 10.1.9
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div id="overlay-search-container" class="nav-header-search">
<input id="overlay-search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="nav-toc">
<ul>
  <li><a href="../security.html" class="page">! Security Announcements !</a></li>
  <li><a href="../release-notes/index.html" class="page">0. Release Notes</a></li>
  <li><a href="../introduction.html" class="page">1. Introduction</a></li>
  <li><a href="../usage.html" class="page">2. Usage</a></li>
  <li><a href="../common/index.html" class="page">3. Data Types &amp; Abstractions</a></li>
  <li><a href="../server-side/index.html" class="page">4. Server API</a></li>
  <li><a href="index.html" class="page">5. Client API</a>
  <ul>
    <li><a href="request-and-response.html" class="page">HttpRequest and HttpResponse</a></li>
    <li><a href="request-level.html" class="page">Request-Level Client-Side API</a></li>
    <li><a href="host-level.html" class="page">Host-Level Client-Side API</a></li>
    <li><a href="connection-level.html#connection-level-client-side-api" class="active page">Connection-Level Client-Side API</a>
    <ul>
      <li><a href="connection-level.html#opening-http-connections" class="header">Opening HTTP Connections</a></li>
      <li><a href="connection-level.html#request-response-cycle" class="header">Request-Response Cycle</a></li>
      <li><a href="connection-level.html#closing-connections" class="header">Closing Connections</a></li>
      <li><a href="connection-level.html#timeouts" class="header">Timeouts</a></li>
      <li><a href="connection-level.html#stand-alone-http-layer-usage" class="header">Stand-Alone HTTP Layer Usage</a></li>
    </ul></li>
    <li><a href="client-https-support.html" class="page">Client-Side HTTPS Support</a></li>
    <li><a href="client-transport.html" class="page">Pluggable Client Transports / HTTP(S) proxy Support</a></li>
    <li><a href="websocket-support.html" class="page">Client-Side WebSocket Support</a></li>
  </ul></li>
  <li><a href="../extensions.html" class="page">6. Extensions</a></li>
  <li><a href="../technologies.html" class="page">7. Supported Technologies</a></li>
  <li><a href="../tipsandtricks.html" class="page">8. Tips And Tricks</a></li>
  <li><a href="../contributing.html" class="page">9. Contributing</a></li>
  <li><a href="../reference.html" class="page">10. Reference</a></li>
</ul>
</nav>
</div>
</header>

<aside class="show-for-large">
<header class="nav-header fixed-sidebar-header">
<div class="nav-header-title">
<h1><a href="../index-2.html">Akka HTTP</a></h1>
</div>
<div class="nav-header-version">
Version 10.1.9
</div>
<div class="nav-header-groups">
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
</div>
<div class="nav-header-search">
<input id="search" type="search" class="search" placeholder="Search"/>
</div>
</header>
<nav class="site-nav fixed-sidebar-contents">
<div class="nav-toc">
<ul>
  <li><a href="../security.html" class="page">! Security Announcements !</a></li>
  <li><a href="../release-notes/index.html" class="page">0. Release Notes</a></li>
  <li><a href="../introduction.html" class="page">1. Introduction</a></li>
  <li><a href="../usage.html" class="page">2. Usage</a></li>
  <li><a href="../common/index.html" class="page">3. Data Types &amp; Abstractions</a></li>
  <li><a href="../server-side/index.html" class="page">4. Server API</a></li>
  <li><a href="index.html" class="page">5. Client API</a>
  <ul>
    <li><a href="request-and-response.html" class="page">HttpRequest and HttpResponse</a></li>
    <li><a href="request-level.html" class="page">Request-Level Client-Side API</a></li>
    <li><a href="host-level.html" class="page">Host-Level Client-Side API</a></li>
    <li><a href="connection-level.html#connection-level-client-side-api" class="active page">Connection-Level Client-Side API</a>
    <ul>
      <li><a href="connection-level.html#opening-http-connections" class="header">Opening HTTP Connections</a></li>
      <li><a href="connection-level.html#request-response-cycle" class="header">Request-Response Cycle</a></li>
      <li><a href="connection-level.html#closing-connections" class="header">Closing Connections</a></li>
      <li><a href="connection-level.html#timeouts" class="header">Timeouts</a></li>
      <li><a href="connection-level.html#stand-alone-http-layer-usage" class="header">Stand-Alone HTTP Layer Usage</a></li>
    </ul></li>
    <li><a href="client-https-support.html" class="page">Client-Side HTTPS Support</a></li>
    <li><a href="client-transport.html" class="page">Pluggable Client Transports / HTTP(S) proxy Support</a></li>
    <li><a href="websocket-support.html" class="page">Client-Side WebSocket Support</a></li>
  </ul></li>
  <li><a href="../extensions.html" class="page">6. Extensions</a></li>
  <li><a href="../technologies.html" class="page">7. Supported Technologies</a></li>
  <li><a href="../tipsandtricks.html" class="page">8. Tips And Tricks</a></li>
  <li><a href="../contributing.html" class="page">9. Contributing</a></li>
  <li><a href="../reference.html" class="page">10. Reference</a></li>
</ul>
</div>
</nav>
<footer class="nav-footer fixed-sidebar-footer">
<a href="https://akka.io/"><img class="logo" src="../images/akka-logo-reverse.svg"/></a>

</footer>
</aside>

<main class="fixed-shift-for-large expanded row">
<section class="site-content small-12 column">

<article class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#connection-level-client-side-api" name="connection-level-client-side-api" class="anchor"><span class="anchor-link"></span></a>Connection-Level Client-Side API</h1>
<p>The connection-level API is the lowest-level client-side API Akka HTTP provides. It gives you full control over when HTTP connections are opened and closed and how requests are to be send across which connection. As such it offers the highest flexibility at the cost of providing the least convenience.</p><div class="callout note "><div class="callout-title">Note</div>
<p>It is recommended to first read the <a href="../implications-of-streaming-http-entity.html">Implications of the streaming nature of Request/Response Entities</a> section, as it explains the underlying full-stack streaming concepts, which may be unexpected when coming from a background with non-&ldquo;streaming first&rdquo; HTTP Clients.</p></div>
<h2><a href="#opening-http-connections" name="opening-http-connections" class="anchor"><span class="anchor-link"></span></a>Opening HTTP Connections</h2>
<p>With the connection-level API you open a new HTTP connection to a target endpoint by materializing a <span class="group-java"><a href="https://doc.akka.io/japi/akka/2.5.23/?akka/stream/javadsl/Flow.html">Flow</a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka/2.5.23/akka/stream/scaladsl/Flow.html">Flow</a></span> returned by the <span class="group-scala"><code>Http().outgoingConnection(...)</code></span><span class="group-java"><code>Http.get(system).outgoingConnection(...)</code></span> method. Here is an example:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-http/tree/v10.1.9/docs/src/test/scala/docs/http/scaladsl/HttpClientExampleSpec.scala#L166-L209" target="_blank" title="Go to snippet source"></a><code class="language-scala">import akka.actor.ActorSystem
import akka.http.scaladsl.Http
import akka.http.scaladsl.model._
import akka.stream.ActorMaterializer
import akka.stream.scaladsl._

import scala.concurrent.Future
import scala.util.{ Failure, Success }

object WebClient {
  def main(args: Array[String]): Unit = {
    implicit val system = ActorSystem()
    implicit val materializer = ActorMaterializer()
    implicit val executionContext = system.dispatcher

    val connectionFlow: Flow[HttpRequest, HttpResponse, Future[Http.OutgoingConnection]] =
      Http().outgoingConnection(&quot;akka.io&quot;)

    def dispatchRequest(request: HttpRequest): Future[HttpResponse] =
      // This is actually a bad idea in general. Even if the `connectionFlow` was instantiated only once above,
      // a new connection is opened every single time, `runWith` is called. Materialization (the `runWith` call)
      // and opening up a new connection is slow.
      //
      // The `outgoingConnection` API is very low-level. Use it only if you already have a `Source[HttpRequest, _]`
      // (other than Source.single) available that you want to use to run requests on a single persistent HTTP
      // connection.
      //
      // Unfortunately, this case is so uncommon, that we couldn&#39;t come up with a good example.
      //
      // In almost all cases it is better to use the `Http().singleRequest()` API instead.
      Source.single(request)
        .via(connectionFlow)
        .runWith(Sink.head)

    val responseFuture: Future[HttpResponse] = dispatchRequest(HttpRequest(uri = &quot;/&quot;))

    responseFuture.andThen {
      case Success(_) =&gt; println(&quot;request succeeded&quot;)
      case Failure(_) =&gt; println(&quot;request failed&quot;)
    }.andThen {
      case _ =&gt; system.terminate()
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-http/tree/v10.1.9/docs/src/test/java/docs/http/javadsl/HttpClientExampleDocTest.java#L195-L215" target="_blank" title="Go to snippet source"></a><code class="language-java"><br/>final ActorSystem system = ActorSystem.create();
final ActorMaterializer materializer = ActorMaterializer.create(system);

final Flow&lt;HttpRequest, HttpResponse, CompletionStage&lt;OutgoingConnection&gt;&gt; connectionFlow =
        Http.get(system).outgoingConnection(toHost(&quot;akka.io&quot;, 80));
final CompletionStage&lt;HttpResponse&gt; responseFuture =
        // This is actually a bad idea in general. Even if the `connectionFlow` was instantiated only once above,
        // a new connection is opened every single time, `runWith` is called. Materialization (the `runWith` call)
        // and opening up a new connection is slow.
        //
        // The `outgoingConnection` API is very low-level. Use it only if you already have a `Source[HttpRequest, _]`
        // (other than Source.single) available that you want to use to run requests on a single persistent HTTP
        // connection.
        //
        // Unfortunately, this case is so uncommon, that we couldn&#39;t come up with a good example.
        //
        // In almost all cases it is better to use the `Http().singleRequest()` API instead.
        Source.single(HttpRequest.create(&quot;/&quot;))
                .via(connectionFlow)
                .runWith(Sink.&lt;HttpResponse&gt;head(), materializer);</code></pre></dd>
</dl>
<p>Apart from the host name and port the <span class="group-scala"><code>Http().outgoingConnection(...)</code></span><span class="group-java"><code>Http.get(system).outgoingConnection(...)</code></span> method also allows you to specify socket options and a number of configuration settings for the connection.</p>
<p>Note that no connection is attempted until the returned flow is actually materialized! If the flow is materialized several times then several independent connections will be opened (one per materialization). If the connection attempt fails, for whatever reason, the materialized flow will be immediately terminated with a respective exception.</p>
<h2><a href="#request-response-cycle" name="request-response-cycle" class="anchor"><span class="anchor-link"></span></a>Request-Response Cycle</h2>
<p>Once the connection flow has been materialized it is ready to consume <span class="group-java"><a href="https://doc.akka.io/japi/akka-http/10.1.9/?akka/http/javadsl/model/HttpRequest.html">HttpRequest</a></span><span class="group-scala"><a href="https://doc.akka.io/api/akka-http/10.1.9/akka/http/scaladsl/model/HttpRequest.html">HttpRequest</a></span> instances from the source it is attached to. Each request is sent across the connection and incoming responses dispatched to the downstream pipeline. Of course and as always, back-pressure is adequately maintained across all parts of the connection. This means that, if the downstream pipeline consuming the HTTP responses is slow, the request source will eventually be slowed down in sending requests.</p>
<p>Any errors occurring on the underlying connection are surfaced as exceptions terminating the response stream (and canceling the request source).</p>
<h2><a href="#closing-connections" name="closing-connections" class="anchor"><span class="anchor-link"></span></a>Closing Connections</h2>
<p>Akka HTTP actively closes an established connection upon reception of a response containing <code>Connection: close</code> header. The connection can also be closed by the server.</p>
<p>An application can actively trigger the closing of the connection by completing the request stream. In this case the underlying TCP connection will be closed when the last pending response has been received.</p>
<p>The connection will also be closed if the response entity is cancelled (e.g. by attaching it to <code>Sink.cancelled()</code>) or consumed only partially (e.g. by using <code>take</code> combinator). In order to prevent this behaviour the entity should be explicitly drained by attaching it to <code>Sink.ignore()</code>.</p>
<h2><a href="#timeouts" name="timeouts" class="anchor"><span class="anchor-link"></span></a>Timeouts</h2>
<p>Currently Akka HTTP doesn&rsquo;t implement client-side request timeout checking itself as this functionality can be regarded as a more general purpose streaming infrastructure feature.</p>
<p>It should be noted that Akka Streams provide various timeout functionality so any API that uses streams can benefit from the stream stages such as <code>idleTimeout</code>, <code>backpressureTimeout</code>, <code>completionTimeout</code>, <code>initialTimeout</code> and <code>throttle</code>. To learn more about these refer to their documentation in Akka Streams.</p>
<p>For more details about timeout support in Akka HTTP in general refer to <a href="../common/timeouts.html">Akka HTTP Timeouts</a>.</p>
<a id="http-client-layer"></a>
<h2><a href="#stand-alone-http-layer-usage" name="stand-alone-http-layer-usage" class="anchor"><span class="anchor-link"></span></a>Stand-Alone HTTP Layer Usage</h2>
<p>Due to its Reactive-Streams-based nature the Akka HTTP layer is fully detachable from the underlying TCP interface. While in most applications this &ldquo;feature&rdquo; will not be crucial it can be useful in certain cases to be able to &ldquo;run&rdquo; the HTTP layer (and, potentially, higher-layers) against data that do not come from the network but rather some other source. Potential scenarios where this might be useful include tests, debugging or low-level event-sourcing (e.g by replaying network traffic).</p>
<p>On the client-side the stand-alone HTTP layer forms a <code>BidiStage</code> stage that &ldquo;upgrades&rdquo; a potentially encrypted raw connection to the HTTP level. It is defined like this:</p><div class="group-scala">
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/akka/akka-http/tree/v10.1.9/akka-http-core/src/main/scala/akka/http/scaladsl/Http.scala#L912-L924" target="_blank" title="Go to snippet source"></a><code class="language-scala">/**
 * The type of the client-side HTTP layer as a stand-alone BidiFlow
 * that can be put atop the TCP layer to form an HTTP client.
 *
 * {{{
 *                +------+
 * HttpRequest  ~&gt;|      |~&gt; SslTlsOutbound
 *                | bidi |
 * HttpResponse &lt;~|      |&lt;~ SslTlsInbound
 *                +------+
 * }}}
 */
type ClientLayer = BidiFlow[HttpRequest, SslTlsOutbound, SslTlsInbound, HttpResponse, NotUsed]</code></pre></div><div class="group-java">
<pre class="prettyprint"><code class="language-java">BidiFlow&lt;HttpRequest, SslTlsOutbound, SslTlsInbound, HttpResponse, NotUsed&gt;
</code></pre></div>
<p>You create an instance of <span class="group-scala"><code>Http.ClientLayer</code></span><span class="group-java">the layer</span> by calling one of the two overloads of the <span class="group-scala"><code>Http().clientLayer</code></span><span class="group-java"><code>Http.get(system).clientLayer</code></span> method, which also allows for varying degrees of configuration.</p>
</div>
</article>

<div class="row">
<div class="small-12 large-9 column">
<section class="nav-prev-next row">
<div class="nav-prev small-6 column">
<a href="host-level.html"><i class="icon-prev"></i> <span class="link-prev">Host-Level Client-Side API</span></a>
</div>
<div class="nav-next small-6 column clearfix">
<a class="float-right" href="client-https-support.html">Client-Side HTTPS Support <i class="icon-next"></i></a>
</div>
</section>
</div>
</div>

<div class="source-github row">
Found an error in this documentation? The source code for this page can be found <a href="https://github.com/akka/akka-http/tree/v10.1.9/docs/src/main/paradox/client-side/connection-level.md">here</a>.
Please feel free to edit and contribute a pull request.
</div>


<footer class="page-footer row clearfix">
<img class="akka-icon float-left show-for-medium" src="../images/akka-icon.svg"/>
<section class="copyright">
<div>Akka HTTP is Open Source and available under the Apache 2 License.</div>
<p class="legal">
&copy; 2011-2019 <a href="https://www.lightbend.com/" target="_blank">Lightbend, Inc.</a> | 
<a href="https://www.lightbend.com/legal/licenses" target="_blank">Licenses</a> | 
<a href="https://www.lightbend.com/legal/terms" target="_blank">Terms</a> | 
<a href="https://www.lightbend.com/legal/privacy" target="_blank">Privacy Policy</a> | 
<a href="https://akka.io/cookie/" target="_blank">Cookie Listing</a> | 
<a class="optanon-toggle-display">Cookie Settings</a>
</p>
</section>
</footer>

</section>
</main>

<script type="text/javascript" src="../js/scrollsneak.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">//<![CDATA[
jQuery(function(){window.prettyPrint && prettyPrint()});
//]]></script>
<!-- Algolia docs search -->
<script type="text/javascript" src="../../../../../cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<style>.algolia-autocomplete { display: block !important }</style>
<script type="text/javascript">
docsearch({
apiKey: '0ccbb8bf5148554a406fbf07df0a93b9',
indexName: 'akka-http',
inputSelector: '#search',
algoliaOptions: {
hitsPerPage: 5
}
});

docsearch({
apiKey: '0ccbb8bf5148554a406fbf07df0a93b9',
indexName: 'akka-http',
inputSelector: '#overlay-search',
algoliaOptions: {
hitsPerPage: 5
}
});

// set up "/" as global shortcut for focusing on search
jQuery(document).keypress(function (event) {
if (event.keyCode == 47) {
jQuery("#search").focus();
return false; // swallow key event, otherwise the / char would be input into the search box
}
});
</script>

<script type="text/javascript" src="../assets/js/warnOldDocs.js"></script>


</body>

<!-- Mirrored from doc.akka.io/docs/akka-http/current/client-side/connection-level.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 01 Aug 2019 10:12:55 GMT -->
</html>
